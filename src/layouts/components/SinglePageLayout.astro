---
import buildToc from "@/lib/utils/buildToc";
import TOC from "./widgets/TableOfContents.astro";
import { getEntryCTM } from "@/lib/contentParser.astro";
import parseTomlToJson from "@/lib/utils/parseTomlToJson";
import OptimizedImage from "./utilities/OptimizedImage.astro";
import formatRelativeDate from "@/lib/utils/formatRelativeDate";
import { markdownify, slugifyyy } from "@/lib/utils/textConverter";
import { render } from "astro:content";
import type { CollectionEntry } from "astro:content";

interface Props {
  content: CollectionEntry<"pages">;
  [key: string]: any;
}

// Configuration and constants
const config = parseTomlToJson("./src/config/config.toml");
const { tableOfContents } = config.settings.markup;

const { content, class: className } = Astro.props;
let { title, date, image, author, categories } = content.data;

// Process markdown content if function is provided
let Content: any, headings;
if (typeof content.render === "function") {
  ({ Content, headings } = await render(content));
}

// Fetch author entry if author name is provided
const authorName = author
  ? (await getEntryCTM("author", slugifyyy(author), Astro.currentLocale))?.data
      ?.title
  : "";

// Build table of contents from headings if available
const tocHeadings = headings ? buildToc(headings) : undefined;

// Check if table of contents is enable
const tocEnabled =
  tableOfContents?.enable && tocHeadings && tocHeadings.length > 0;
---

<section>
  <div class="container">
    <div
      class:list={["has-video-modal max-w-full space-y-10 lg:p-5", className]}>
      {
        image && Content && (
          <OptimizedImage
            width={896}
            height={500}
            alt={title}
            src={image as string}
            class:list={["h-125 w-full object-cover"]}
          />
        )
      }

      <div class="space-y-2">
        <ul
          class="text-dark flex flex-wrap items-center gap-x-5 gap-y-1 tracking-wide">
          {
            date && (
              <li>
                {date && markdownify(formatRelativeDate(date, "dd MMM, yyyy"))}
              </li>
            )
          }

          {
            categories?.map((category: string) => (
              <li class="before:bg-dark relative pe-5 before:absolute before:top-1/2 before:end-0 before:h-1 before:w-1 before:-translate-y-1/2 before:rounded-full before:content-['']">
                {markdownify(category)}
              </li>
            ))
          }

          {
            authorName && (
              <li class="before:bg-dark relative pe-5 before:absolute before:top-1/2 before:end-0 before:h-1 before:w-1 before:-translate-y-1/2 before:rounded-full before:content-['']">
                By {markdownify(authorName)}
              </li>
            )
          }
        </ul>
        {title && <h1 class="text-h2-sm md:text-h2" set:html={title} />}
      </div>
      {tocEnabled && tocHeadings && <TOC toc={tocHeadings} marker={false} />}
      {
        Content && (
          <div class="prose-styles content has-video-modal prose-headings:mb-6 prose-headings:mt-10">
            <Content />
          </div>
        )
      }
    </div>
  </div>
</section>
